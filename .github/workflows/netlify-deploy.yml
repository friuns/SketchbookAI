name: Deploy to Netlify

on:
  push:
    branches:
      - '**'  # Triggers on push to any branch
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to comment on (optional, will try to extract from commit message if not provided)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Deploy to Netlify
        id: netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: '.'
          production-branch: master
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions - ${{ github.event.head_commit.message }}"
          enable-pull-request-comment: true
          enable-commit-comment: true
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 1

      - name: Extract issue number from commit message
        id: extract_issue
        if: github.event_name == 'push'
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          # Extract issue number from commit message (e.g., "fixes #123", "closes #456", "#789")
          # Match keywords followed by #number OR standalone #number at word boundaries
          ISSUE_NUMBER=$(echo "$COMMIT_MSG" | grep -oiE '(fixes|closes|resolves|fix|close|resolve)\s*#([0-9]+)|#([0-9]+)' | grep -oE '[0-9]+' | head -1)
          if [ -n "$ISSUE_NUMBER" ]; then
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "Found issue number: $ISSUE_NUMBER"
          else
            echo "No issue number found in commit message"
            echo "issue_number=" >> $GITHUB_OUTPUT
          fi

      - name: Comment on issue with deployment URL
        if: steps.extract_issue.outputs.issue_number != '' || inputs.issue_number != ''
        run: |
          # Use workflow input if provided, otherwise use extracted issue number
          ISSUE_NUM="${{ inputs.issue_number }}"
          if [ -z "$ISSUE_NUM" ]; then
            ISSUE_NUM="${{ steps.extract_issue.outputs.issue_number }}"
          fi

          if [ -n "$ISSUE_NUM" ]; then
            DEPLOY_URL="${{ steps.netlify.outputs.deploy-url }}"
            BRANCH="${{ github.ref_name }}"
            COMMIT_SHA="${{ github.sha }}"
            WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            # Create comment body
            printf "ðŸš€ **Netlify Deployment**\n\n" > /tmp/comment.md
            printf "The branch \`%s\` has been deployed to Netlify!\n\n" "$BRANCH" >> /tmp/comment.md
            printf "**ðŸ”— Deployment URL:** %s\n\n" "$DEPLOY_URL" >> /tmp/comment.md
            printf "Deployed from commit: %s\n" "$COMMIT_SHA" >> /tmp/comment.md
            printf "Workflow run: %s\n" "$WORKFLOW_URL" >> /tmp/comment.md

            gh issue comment "$ISSUE_NUM" --body-file /tmp/comment.md
            echo "Posted deployment URL to issue #$ISSUE_NUM"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

