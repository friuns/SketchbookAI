name: Deploy to Netlify

on:
  push:
    branches:
      - '**'  # Triggers on push to any branch
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to comment on (optional, will try to extract from commit message if not provided)'
        required: false
        type: string

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Deploy to Netlify
        id: netlify
        uses: nwtgck/actions-netlify@v3.0
        with:
          publish-dir: '.'
          production-branch: master
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions - ${{ github.event.head_commit.message }}"
          enable-pull-request-comment: true
          enable-commit-comment: true
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 1

      - name: Extract issue number from commit message
        id: extract_issue
        if: github.event_name == 'push'
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          # Extract issue number from commit message
          # First try matching keywords followed by issue number (fixes #123, closes #456)
          ISSUE_NUMBER=$(echo "$COMMIT_MSG" | grep -oiE '(fixes|closes|resolves|fix|close|resolve)\s+#[0-9]+' | grep -oE '[0-9]+' | head -1)
          # If not found, try matching standalone #number at start of message
          if [ -z "$ISSUE_NUMBER" ]; then
            ISSUE_NUMBER=$(echo "$COMMIT_MSG" | grep -oE '^#[0-9]+' | grep -oE '[0-9]+' | head -1)
          fi
          if [ -n "$ISSUE_NUMBER" ]; then
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "Found issue number: $ISSUE_NUMBER"
          else
            echo "No issue number found in commit message"
            echo "issue_number=" >> $GITHUB_OUTPUT
          fi

      - name: Comment on issue with deployment URL
        if: |
          (github.event_name == 'push' && steps.extract_issue.outputs.issue_number != '') ||
          (github.event_name == 'workflow_dispatch' && inputs.issue_number != '')
        run: |
          # Use workflow input if provided, otherwise use extracted issue number
          ISSUE_NUM="${{ inputs.issue_number }}"
          if [ -z "$ISSUE_NUM" ]; then
            ISSUE_NUM="${{ steps.extract_issue.outputs.issue_number }}"
          fi

          if [ -n "$ISSUE_NUM" ]; then
            DEPLOY_URL="${{ steps.netlify.outputs.deploy-url }}"
            BRANCH="${{ github.ref_name }}"
            COMMIT_SHA="${{ github.sha }}"
            WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            # Create comment body with proper escaping
            # Escape special characters in branch name for markdown
            SAFE_BRANCH=$(echo "$BRANCH" | sed 's/`/\\`/g')
            {
              echo "üöÄ **Netlify Deployment**"
              echo ""
              echo "The branch \`${SAFE_BRANCH}\` has been deployed to Netlify!"
              echo ""
              echo "**üîó Deployment URL:** ${DEPLOY_URL}"
              echo ""
              echo "Deployed from commit: ${COMMIT_SHA}"
              echo "Workflow run: ${WORKFLOW_URL}"
            } > /tmp/comment.md

            # Post comment with error handling
            if gh issue comment "$ISSUE_NUM" --body-file /tmp/comment.md; then
              echo "‚úÖ Posted deployment URL to issue #$ISSUE_NUM"
            else
              echo "‚ùå Failed to post comment to issue #$ISSUE_NUM"
              echo "Please check if the issue exists and you have the necessary permissions"
              exit 1
            fi
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

